<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SCAHSD – Caracterização de Altas Habilidades/Superdotação - Segunda Fonte</title>
<meta name="description" content="Formulário SCAHSD para identificação de indicadores de altas habilidades/superdotação. Integrada Neuropsicologia.">
<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --line:#1f2937;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --pri:#4f46e5;
  --ok:#22c55e;
  --err:#ef4444;
  --chip:#0b1220;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.wrap{
  max-width:1000px;
  margin:24px auto;
  padding:0 16px;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:20px;
  box-shadow:0 0 10px #0004;
}
h1{
  font-size:1.35rem;
  margin-bottom:4px;
}
.muted{color:var(--muted)}
.grid-info{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin:16px 0;
}
@media(max-width:720px){.grid-info{grid-template-columns:1fr}}
.info{
  background:var(--chip);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
}
.info b{display:block;color:#cbd5e1;margin-bottom:4px}
.q{
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--chip);
  padding:12px;
  margin-bottom:10px;
}
.q h3{margin:0 0 6px;font-size:.95rem}
.opts{display:flex;flex-wrap:wrap;gap:8px}
label.opt{
  display:flex;
  align-items:center;
  gap:6px;
  background:#111827;
  border:1px solid #1f2937;
  border-radius:9px;
  padding:6px 10px;
  cursor:pointer;
}
label.opt:has(input[type="radio"]:checked){
  background:var(--pri);
  border-color:var(--pri);
  color:#fff;
}
label.opt span{color:inherit}
label.opt input{accent-color:var(--pri)}
.btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:var(--ok);
  border:none;
  border-radius:10px;
  color:#fff;
  padding:10px 14px;
  cursor:pointer;
  font-weight:600;
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.msg{margin:10px 0;padding:10px;border-radius:8px}
.okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
.errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
.warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SCAHSD – Caracterização de Altas Habilidades/Superdotação - Segunda Fonte</h1>
    <p class="muted">
      Para cada afirmação, selecione a frequência com que o comportamento ocorre.  
      As opções são: <b>Nunca</b>, <b>Raramente</b>, <b>Às vezes</b>, <b>Frequentemente</b> e <b>Sempre</b>.
    </p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <button id="btnSubmit" class="btn" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// =============================
// CONFIGURAÇÃO GERAL SCAHSD
// =============================
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS: "Patients",
  TOKENS: "LinkTokens",
  SCORES: "Scores_SCAHSD_SEGUNDA_FONTE"
};
const CODE = "SCAHSD_SEGUNDA_FONTE";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const SOURCE = "pais";

const $ = s => document.querySelector(s);
const qs = k => new URLSearchParams(location.search).get(k) || "";
const onlyDigits = s => (s || "").replace(/\D+/g,"");
const AUTOSAVE_KEY = `${CODE}_${qs("token") || "no_token"}`;

// =============================
// FUNÇÕES AUXILIARES
// =============================
function setBox(id, text, kind="ok"){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok" ? "okbox" : kind==="warn" ? "warnbox" : "errbox");
  el.style.display = "block";
}
function hideBox(id){const el=$(id);if(el){el.style.display="none";el.textContent="";}}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){const r=await fetch(url);if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}
async function POST(url,body){
  const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(await r.text());
  return r.json();
}
async function PATCH(url,body){
  const r=await fetch(url,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(await r.text());
  return r.json();
}
async function sheetSearch(sheet,params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet,row){
  return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{data:[row]});
}
async function sheetPatchBy(sheet,col,val,data){
  return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(col)}/${encodeURIComponent(val)}?sheet=${encodeURIComponent(sheet)}`,{data});
}
function goPortalWithToken(){
  const TOKEN=qs("token");
  try{
    const u=new URL(PORTAL_URL,location.href);
    u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN);
  }
}

// =============================
// VARIÁVEIS GLOBAIS
// =============================
let patient=null;
let CPF="";
let startAt=Date.now();

// =============================
// INICIALIZAÇÃO (BOOT)
// =============================
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){setBox("#alert","Link inválido (sem token).","err");return;}
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length)throw new Error("Token inválido ou expirado.");
    const tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired=tokenRow.expires_at&&(Date.parse(tokenRow.expires_at)<Date.now());
    if(disabled||expired)throw new Error("Token desativado/expirado.");

    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF)throw new Error("Token sem CPF vinculado.");
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length)throw new Error("Paciente não encontrado.");
    patient=prows[0];
    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){setBox("#alert","Formulário não liberado para este participante.","err");return;}

    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    if(already?.length||flagDone){
      setBox("#alert","Formulário já respondido. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }
    renderPatientInfo();
    $("#form").style.display="block";
    $("#pacInfo").style.display="grid";
    hideBox("#alert");
    startAt=Date.now();
  }catch(err){
    console.error(err);
    setBox("#alert",err.message||"Falha ao abrir o formulário.","err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo");
  g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["Nascimento",fmtDateISO(patient.data_nascimento)]];
  for(const [k,v]of info){
    const d=document.createElement("div");
    d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  }
}


// =============================
// PARTE 2 — PERGUNTAS E CÁLCULOS
// =============================

// ---------- LISTA DE PERGUNTAS ----------
const QUESTIONS = [
  // Dimensão 1: Habilidades Intelectuais Avançadas
  "Aprende rapidamente conceitos complexos, mesmo quando os colegas ainda estão entendendo o básico.",
  "Recorda detalhes de histórias ou explicações após semanas ou meses.",
  "Resolve quebra-cabeças ou desafios de lógica com facilidade.",
  "Durante conversas, identifica falhas lógicas e propõe correções.",
  "Passa tempo pesquisando assuntos acadêmicos fora do conteúdo escolar.",
  "Prefere livros ou temas mais avançados (ex: filosofia, história antiga).",
  "Usa conhecimentos de uma área para compreender outra (ex: usa física para entender biologia).",
  "Analisa diferentes pontos de vista antes de formar uma opinião.",
  "Consegue explicar ideias abstratas com exemplos próprios.",
  "Aplica conhecimentos aprendidos em novos contextos.",

  // Dimensão 2: Criatividade e Originalidade
  "Apresenta ideias originais e soluções criativas para problemas.",
  "Cria histórias ou desenhos com enredos e personagens elaborados.",
  "Propõe novas maneiras de organizar ou realizar atividades.",
  "Sugeriu métodos alternativos para resolver exercícios.",
  "Apresenta múltiplas perspectivas antes de decidir algo.",
  "Mostra curiosidade e gosta de explorar assuntos novos.",
  "Combina ideias diferentes para criar algo novo.",
  "Propõe múltiplas soluções para problemas complexos.",
  "Gosta de experimentar novas formas de fazer as coisas.",
  "Explica conceitos abstratos com exemplos criativos.",

  // Dimensão 3: Motivação e Persistência
  "Demonstra vontade de realizar tarefas, mesmo sem ser solicitado.",
  "Continua uma tarefa até terminá-la, mesmo com dificuldades.",
  "Mantém o foco por longos períodos em atividades desafiadoras.",
  "Cumpre prazos e metas sem precisar de cobrança.",
  "Busca sempre fazer o melhor possível no que realiza.",
  "Toma iniciativa e decide o que fazer por conta própria.",
  "Gosta de atividades que exigem esforço e superação.",
  "Não desiste facilmente diante de obstáculos.",
  "Demonstra interesse contínuo em aprender mais sobre um tema.",
  "Controla emoções e comportamento para atingir seus objetivos.",

  // Dimensão 4: Capacidade de Liderança
  "Divide tarefas e coordena atividades em grupo com segurança.",
  "Fala com clareza e convicção, expressando suas ideias com confiança.",
  "Organiza grupos ou eventos para garantir que tudo funcione bem.",
  "Motiva colegas e oferece apoio quando estão desanimados.",
  "Tenta resolver conflitos entre colegas com diálogo e empatia.",
  "Distribui tarefas conforme as habilidades de cada participante.",
  "Toma decisões rápidas e explica suas escolhas com segurança.",
  "Percebe quando alguém está excluído e busca incluir essa pessoa.",
  "Mantém a calma e ajuda o grupo mesmo sob pressão.",
  "Ensina colegas com paciência, mesmo que isso leve mais tempo.",

  // Dimensão 5: Sensibilidade Emocional
  "Percebe quando alguém está triste e demonstra preocupação.",
  "Mostra empatia e oferece conforto quando alguém passa por um momento difícil.",
  "Adota uma postura calma em ambientes tensos.",
  "Sugere pausas ou momentos de relaxamento quando há estresse.",
  "Demonstra cuidado e interesse pelo bem-estar dos outros.",
  "Consegue expressar suas emoções de forma clara e respeitosa.",
  "Reage contra injustiças, mesmo que isso cause desconforto.",
  "Percebe emoções alheias observando gestos e expressões corporais.",
  "Tenta resolver conflitos com base no diálogo e nas emoções envolvidas.",
  "Mostra tolerância e respeito por pessoas com opiniões diferentes.",

  // Dimensão 6: Interesses Avançados
  "Prefere estudar temas complexos como história, ciência ou psicologia.",
  "Busca conhecimento por conta própria, lendo ou fazendo cursos online.",
  "Participa de atividades avançadas, como feiras de ciências ou projetos de pesquisa.",
  "Mantém interesse prolongado por um mesmo tema ao longo dos anos.",
  "Compartilha conhecimento com colegas e professores com clareza.",
  "Cria projetos independentes para investigar temas de seu interesse.",
  "Entende conceitos complexos e consegue explicá-los de forma simples.",
  "Integra conhecimentos de várias áreas para compreender temas amplos.",
  "Demonstra especial interesse por um campo específico do saber.",
  "Gosta de discutir assuntos complexos com outras pessoas interessadas."
];

// ---------- MAPEAMENTO DE DIMENSÕES ----------
const DIM_RANGES = {
  "Habilidades Intelectuais Avançadas": [1,10],
  "Criatividade e Originalidade": [11,20],
  "Motivação e Persistência": [21,30],
  "Capacidade de Liderança": [31,40],
  "Sensibilidade Emocional": [41,50],
  "Interesses Avançados": [51,60]
};

// ---------- VALORES DE RESPOSTA ----------
const OPTS = [
  {label:"Nunca", val:1},
  {label:"Raramente", val:2},
  {label:"Às vezes", val:2},
  {label:"Frequentemente", val:3},
  {label:"Sempre", val:4}
];

// ---------- RENDERIZAÇÃO ----------
function renderQuestions(){
  const host=$("#qs");
  host.innerHTML="";
  QUESTIONS.forEach((txt,idx)=>{
    const n=idx+1;
    const qn=String(n).padStart(3,"0");
    const wrap=document.createElement("div");
    wrap.className="q";
    wrap.innerHTML=`<h3>${n}. ${txt}</h3>`;
    const opts=document.createElement("div");
    opts.className="opts";
    OPTS.forEach((o,i)=>{
      const id=`q${qn}_${i}`;
      const l=document.createElement("label");
      l.className="opt";
      l.innerHTML=`<input type="radio" name="q${qn}" id="${id}" value="${o.val}" required><span>${o.label}</span>`;
      opts.appendChild(l);
    });
    wrap.appendChild(opts);
    host.appendChild(wrap);
  });
  updateProgress();
  host.addEventListener("input",()=>{updateProgress();autosaveAnswers();});
  host.addEventListener("change",()=>{updateProgress();autosaveAnswers();});
}

function updateProgress(){
  const N=QUESTIONS.length;
  const answered=[...document.querySelectorAll("input[type=radio]:checked")].length;
  $("#progress").textContent=`${answered}/${N} respondidas`;
}

// ---------- AUTOSAVE ----------
function autosaveAnswers(){
  const stored={};
  QUESTIONS.forEach((_,idx)=>{
    const n=idx+1;
    const qn=String(n).padStart(3,"0");
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) stored[n]=Number(sel.value);
  });
  localStorage.setItem(AUTOSAVE_KEY,JSON.stringify(stored));
}
function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw)return;
    const data=JSON.parse(raw);
    Object.entries(data).forEach(([k,v])=>{
      const qn=String(k).padStart(3,"0");
      const el=document.querySelector(`input[name="q${qn}"][value="${v}"]`);
      if(el)el.checked=true;
    });
    updateProgress();
  }catch(_){}
}
function clearAutosave(){localStorage.removeItem(AUTOSAVE_KEY);}

// ---------- CÁLCULOS ----------
function calcDimensionScores(answers){
  const res={};
  for(const [dim,[start,end]] of Object.entries(DIM_RANGES)){
    let sum=0,count=0;
    for(let i=start;i<=end;i++){
      if(answers[i]){sum+=Number(answers[i]);count++;}
    }
    res[dim]={total:sum,count,mean:count?sum/count:0};
  }
  return res;
}

function interpretDimension(sum){
  if(sum>=40)return"Excelente nível de interesse em temas avançados, indicando alta capacidade de aprendizado e profundidade de conhecimento.";
  if(sum>=30)return"Bom nível de interesse em temas avançados, com forte tendência a se envolver em atividades especializadas.";
  if(sum>=20)return"Interesse em temas dentro do esperado para a faixa etária.";
  return"Baixo nível de interesse em temas avançados, indicando necessidade de desenvolvimento e exploração adicional.";
}

function interpretGeneral(sum){
  if(sum>=240)return"Indica características consistentes com altas habilidades e superdotação.";
  if(sum>=180)return"Indica potencial elevado para altas habilidades, com destaque em algumas áreas específicas.";
  if(sum>=120)return"Características dentro do esperado para a faixa etária, sem indicativos claros de altas habilidades.";
  return"Baixa pontuação, indicando necessidade de estímulo adicional e suporte educacional.";
}

// ---------- SUBMISSÃO ----------
$("#form").addEventListener("submit",async e=>{
  e.preventDefault();
  hideBox("#msg");
  const btn=$("#btnSubmit");
  const original=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando…";

  try{
    const answers={};
    let firstMissing=null;
    QUESTIONS.forEach((_,idx)=>{
      const n=idx+1;
      const qn=String(n).padStart(3,"0");
      const sel=document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel && firstMissing===null)firstMissing=n;
      if(sel)answers[n]=Number(sel.value);
    });
    if(firstMissing){
      setBox("#msg",`Responda o item ${firstMissing}.`,"warn");
      document.getElementById(`lbl${String(firstMissing).padStart(3,"0")}`)?.scrollIntoView({behavior:"smooth",block:"center"});
      btn.disabled=false;
      btn.textContent=original;
      return;
    }

    const dims=calcDimensionScores(answers);
    const totalSum=Object.values(dims).reduce((a,b)=>a+b.total,0);
    let categoria="";
    for(const [dim,v] of Object.entries(dims)){
      categoria+=`${dim}: ${interpretDimension(v.total)} `;
    }
    categoria+=" | Interpretação geral: "+interpretGeneral(totalSum);

    const questionsStr=QUESTIONS.map((txt,idx)=>{
      const n=idx+1;
      const val=answers[n]??"";
      const label=OPTS.find(o=>o.val===val)?.label||"";
      return `${n}. ${txt} => ${label}`;
    }).join(" | ");

    const durationSec=Math.round((Date.now()-startAt)/1000);
    const row={
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),
      cpf:patient.cpf,
      code:CODE,
      source:SOURCE,
      submitted_at:new Date().toISOString(),
      questions:questionsStr,
      categoria:categoria,
      metrics:JSON.stringify({answers,dims,totalSum,duration_sec:durationSec})
    };

    await sheetCreate(SHEETS.SCORES,row);
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{[`${CODE}_FEITO`]:"sim",[`${CODE}_FEITO_AT`]:new Date().toISOString()});

    clearAutosave();
    setBox("#msg","Formulário enviado com sucesso! Retornando ao portal…","ok");
    setTimeout(goPortalWithToken,1500);
  }catch(err){
    console.error(err);
    setBox("#msg",err.message||"Falha ao enviar. Tente novamente.","err");
    btn.disabled=false;
    btn.textContent=original;
  }
});

// ---------- INICIALIZAÇÃO ----------
renderQuestions();
restoreAutosave();


</script>
</body>
</html>
